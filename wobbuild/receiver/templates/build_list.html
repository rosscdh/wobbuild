{% extends 'base.html' %}

{% block body %}
{% raw %}



<div class="row">
    <div class="col-md-12">
      <h2>Latest Builds</h2>
    </div>

      <div id="container"></div>

</div>

<div id="modal-logs" class="modal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h4 class="modal-title"></h4>
      </div>
      <div class="modal-body">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endraw %}
{% endblock %}

{% block js %}
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pusher/4.1.0/pusher.worker.min.js"></script>
<script type="text/babel">
  var destination = document.querySelector("#container");

  var initialBuilds = {{ object_list|tojson|safe }};

  var PusherService = {
    APP_KEY: '1234567890',
    wsHost: '192.168.50.5',
    wsPort: '8080',
    socket: function () {
      return new Pusher(this.APP_KEY, {
                wsHost: this.wsHost,
                wsPort: this.wsPort,
                // wssPort: "8080",
                enabledTransports: ['ws'],
                //httpPort: 8080,
                encrypted: false,
              });
    }
  }

  var BuildsService = {
    uri: '/api/builds',

    builds: function () {
      return axios.get( this.uri )
    },
    build: function (slug) {
      return axios.get( this.uri + '/' + slug )
    }
  }
{% raw %}
  var Build = React.createClass({
  render: function() {
    var build = this.props.build;
    return (
      <div className="col-md-4">
        <div className="panel">
          <div className="panel-heading">
            <h3 className="panel-title">
              <a href="{ build.pipeline.repo.url }">{ build.project.name }@{ build.pipeline.repo.branch }</a>
              <span className="pull-right text-right"><i className="material-icons">flight takeoff</i></span>
            </h3>
          </div>
          <div className="panel-body">
            <div className="bs-component">
              <div className="progress">
                <div className="progress-bar" style={{'width' : '30%'}}></div>
              </div>
            </div>
            <p>
            Build time: { build.dateof }
            </p>
            <button type="button" className="btn btn-block btn-danger" data-build_slug="{ build.slug }" data-toggle="modal" data-target="#modal-logs">View Failed<div className="ripple-container"></div></button>
            <button type="button" className="btn btn-block btn-xs btn-info">Re-Run Build</button>
          </div>
        </div>
      </div>
    );
  }
  });

  var Builds = React.createClass({
    getInitialState: function() {
        return { 'builds': [] };
    },
    componentDidMount: function() {
      /**
      * Collect Builds
      */
      var buildsProvider = BuildsService.builds();
      buildsProvider.then(res => {
        var builds = res.data.map(obj => <Build key={obj.slug} build={obj}/>);
        this.setState({
          'builds': builds
        });
      });
      /**
      * Handle sockets here
      */
      var socket = PusherService.socket();
      var channel = socket.subscribe('builds');
      channel.bind('new-build', function(data) { console.log(data) });
      channel.bind('new-build-log', function(data) { console.log(data) });
    },
    render: function() {
      return (<div className="row">{this.state.builds}</div>)
    }
  });

  function App() {
    return (
      <div>
        <Builds />
      </div>
    );
  }

  ReactDOM.render(
    <ReactRouter.Router history={ReactRouter.hashHistory}>
    <ReactRouter.Route path="/" component={App}>

    </ReactRouter.Route>
    </ReactRouter.Router>,
    destination
  );
{% endraw %}
</script>
{% endblock %}
